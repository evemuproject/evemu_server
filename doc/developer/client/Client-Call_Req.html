<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>EVEmu Developer documentation</title>

    <!-- jQuery & QUnit -->
    <script type="text/javascript" src="js/jquery-1.4.2.js"></script>
    <script type="text/javascript" src="js/qunit.js"></script>
    <link type="text/css" rel="stylesheet" href="js/qunit.css"/>
    <!-- SyntaxHighlighter -->
    <script type="text/javascript" src="../syntaxhighlighter_3.0.83/scripts/shCore.js"></script>
    <script type="text/javascript" src="../syntaxhighlighter_3.0.83/scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="../syntaxhighlighter_3.0.83/scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="../syntaxhighlighter_3.0.83/scripts/shBrushDiff.js"></script>
    <script type="text/javascript" src="../syntaxhighlighter_3.0.83/scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="../syntaxhighlighter_3.0.83/scripts/shBrushSql.js"></script>
    <script type="text/javascript" src="../syntaxhighlighter_3.0.83/scripts/shBrushXml.js"></script>

    <link type="text/css" rel="stylesheet" href="../syntaxhighlighter_3.0.83/styles/shCoreDefault.css"/>
    <script type="text/javascript">SyntaxHighlighter.all();</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
  </head>
  <body>
    <h3>Client CALL_REQ</h3>
    <pre class="brush: cpp">
bool Client::Handle_CallReq( PyPacket* packet, PyCallStream& req )
{
    PyCallable* dest;
    if( packet->dest.service.empty() )
    {
        //previously bound object
        uint32 nodeID, bindID;
        if( sscanf( req.remoteObjectStr.c_str(), "N=%u:%u", &nodeID, &bindID ) != 2 )
        {
            sLog.Error("Client","Failed to parse bind string '%s'.", req.remoteObjectStr.c_str());
            return false;
        }

        if( nodeID != sManager.GetNodeID() )
        {
            sLog.Error("Client","Unknown nodeID %u received (expected %u).", nodeID, sManager.GetNodeID());
            return false;
        }

        dest = sManager.FindBoundObject( bindID );
        if( dest == NULL )
        {
            sLog.Error("Client", "Failed to find bound object %u.", bindID);
            return false;
        }
    }
    else
    {
        //retrieve a new service handler.
        dest = sManager.LookupService( packet->dest.service );
        if( dest == NULL )
        {
            sLog.Error("Client","Unable to find service to handle call to: %s", packet->dest.service.c_str());
            packet->dest.Dump(CLIENT__ERROR, "    ");

#pragma message( "TODO: throw proper exception to client (exceptions.ServiceNotFound)." )
            throw PyException( new PyNone );
        }
    }

    //Debug code
    if( req.method == "BeanCount" )
        sLog.Error("Client","BeanCount");
    else
        //this should be sLog.Debug, but because of the number of messages, I left it as .Log for readability, and ease of finding other debug messages
        sLog.Log("Server", "%s call made to %s",req.method.c_str(),packet->dest.service.c_str());

    //build arguments
    PyCallArgs args( this, req.arg_tuple, req.arg_dict );

    //parts of call may be consumed here
    PyResult result = dest->Call( req.method, args );

    _SendSessionChange();  //send out the session change before the return.
    _SendCallReturn( packet->dest, packet->source.callID, &result.ssResult );

    return true;
}
    </pre>
  </body>
</html>
